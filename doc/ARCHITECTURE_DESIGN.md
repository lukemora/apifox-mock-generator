# Apifox Mock Generator æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒæ¨¡å—](#æ ¸å¿ƒæ¨¡å—)
3. [æ¨¡å—è”åŠ¨](#æ¨¡å—è”åŠ¨)
4. [ä¸»è¦åŠŸèƒ½](#ä¸»è¦åŠŸèƒ½)

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

### æ•´ä½“æ¶æ„

é‡‡ç”¨**åˆ†å±‚æ¶æ„**å’Œ**ä¾èµ–æ³¨å…¥**è®¾è®¡ï¼Œåˆ†ä¸ºå››å±‚ï¼š

![æ¶æ„å›¾](img/architecture-diagram.png)

### ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ scripts/              # CLI å…¥å£è„šæœ¬
â”‚   â”œâ”€â”€ generate-mock.ts  # ç”Ÿæˆå‘½ä»¤å…¥å£
â”‚   â””â”€â”€ serve-mock.ts     # æœåŠ¡å‘½ä»¤å…¥å£
â”œâ”€â”€ core/                 # æ ¸å¿ƒåŸºç¡€è®¾æ–½
â”‚   â”œâ”€â”€ container.ts      # ä¾èµ–æ³¨å…¥å®¹å™¨
â”‚   â”œâ”€â”€ container-setup.ts # å®¹å™¨åˆå§‹åŒ–
â”‚   â”œâ”€â”€ config-loader.ts  # Apifox é…ç½®åŠ è½½
â”‚   â””â”€â”€ mock-config-loader.ts # Mock é…ç½®åŠ è½½
â”œâ”€â”€ domain/               # ä¸šåŠ¡å±‚
â”‚   â”œâ”€â”€ entities/         # ä¸šåŠ¡å®ä½“ï¼ˆApiEndpoint, MockRouteï¼‰
â”‚   â”œâ”€â”€ interfaces.ts     # æ¥å£å®šä¹‰ï¼ˆIApifoxClient, IRouteManager ç­‰ï¼‰
â”‚   â””â”€â”€ services/         # ä¸šåŠ¡æœåŠ¡
â”‚       â”œâ”€â”€ endpoint-filter.service.ts    # ç«¯ç‚¹è¿‡æ»¤
â”‚       â”œâ”€â”€ route-matcher.service.ts      # è·¯ç”±åŒ¹é…
â”‚       â””â”€â”€ openapi-converter.service.ts # OpenAPI è½¬æ¢
â”œâ”€â”€ application/          # åº”ç”¨å±‚
â”‚   â””â”€â”€ use-cases/        # ç”¨ä¾‹
â”‚       â”œâ”€â”€ fetch-apifox-data.use-case.ts
â”‚       â”œâ”€â”€ generate-mock.use-case.ts
â”‚       â”œâ”€â”€ generate-types.use-case.ts
â”‚       â””â”€â”€ serve-mock.use-case.ts
â”œâ”€â”€ infrastructure/       # åŸºç¡€è®¾æ–½å±‚
â”‚   â”œâ”€â”€ apifox/           # Apifox å®¢æˆ·ç«¯å®ç°
â”‚   â”œâ”€â”€ file-system/      # æ–‡ä»¶ç³»ç»Ÿå®ç°
â”‚   â”œâ”€â”€ http/             # HTTP å®¢æˆ·ç«¯å®ç°
â”‚   â”œâ”€â”€ logger/           # æ—¥å¿—å®ç°
â”‚   â”œâ”€â”€ route-manager/    # è·¯ç”±ç®¡ç†å™¨å®ç°
â”‚   â””â”€â”€ server/           # æœåŠ¡å™¨ç›¸å…³
â”‚       â”œâ”€â”€ route-loader.ts    # è·¯ç”±åŠ è½½å™¨
â”‚       â”œâ”€â”€ remote-proxy.ts    # è¿œç¨‹ä»£ç†
â”‚       â””â”€â”€ hot-reload.ts      # çƒ­é‡è½½
â”œâ”€â”€ presentation/         # è¡¨ç°å±‚
â”‚   â””â”€â”€ http/            # HTTP æœåŠ¡å™¨
â”‚       â”œâ”€â”€ express-server.ts  # Express æœåŠ¡å™¨è®¾ç½®
â”‚       â””â”€â”€ route-handler.ts   # è·¯ç”±å¤„ç†å™¨
â”œâ”€â”€ generators/          # ä»£ç ç”Ÿæˆå™¨
â”‚   â”œâ”€â”€ mock-generator.ts      # Mock æ–‡ä»¶ç”Ÿæˆ
â”‚   â”œâ”€â”€ type-generator.ts      # ç±»å‹æ–‡ä»¶ç”Ÿæˆ
â”‚   â””â”€â”€ templates/             # ä»£ç æ¨¡æ¿
â””â”€â”€ types/               # ç±»å‹å®šä¹‰
```

---

## ğŸ“¦ æ ¸å¿ƒæ¨¡å—

### 1. Business Layerï¼ˆä¸šåŠ¡å±‚ï¼‰

**èŒè´£**ï¼šå®šä¹‰ä¸šåŠ¡å®ä½“ã€æ¥å£å’Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œä¸ä¾èµ–å¤–éƒ¨æ¡†æ¶ã€‚

#### å®ä½“ï¼ˆEntitiesï¼‰
- **ApiEndpoint**: API ç«¯ç‚¹å®ä½“ï¼ŒåŒ…å«è·¯å¾„ã€æ–¹æ³•ã€å‚æ•°ç­‰ä¿¡æ¯
- **MockRoute**: Mock è·¯ç”±å®ä½“ï¼ŒåŒ…å«å“åº”æ•°æ®å’ŒéªŒè¯è§„åˆ™

#### æ¥å£ï¼ˆInterfacesï¼‰
- **IApifoxClient**: Apifox API å®¢æˆ·ç«¯æ¥å£
- **IRouteManager**: è·¯ç”±ç®¡ç†å™¨æ¥å£
- **IFileSystem**: æ–‡ä»¶ç³»ç»Ÿæ¥å£
- **ILogger**: æ—¥å¿—æ¥å£
- **IHttpClient**: HTTP å®¢æˆ·ç«¯æ¥å£

#### ä¸šåŠ¡æœåŠ¡ï¼ˆServicesï¼‰
- **EndpointFilterService**: æ ¹æ®é…ç½®è¿‡æ»¤ API ç«¯ç‚¹
- **RouteMatcherService**: åŒ¹é…è¯·æ±‚è·¯å¾„åˆ° Mock è·¯ç”±
- **OpenAPIConverterService**: å°† OpenAPI æ–‡æ¡£è½¬æ¢ä¸ºç«¯ç‚¹å®ä½“

### 2. Application Layerï¼ˆåº”ç”¨å±‚ï¼‰

**èŒè´£**ï¼šç¼–æ’ç”¨ä¾‹ï¼Œåè°ƒä¸šåŠ¡æœåŠ¡ã€‚

#### ç”¨ä¾‹ï¼ˆUse Casesï¼‰
- **FetchApifoxDataUseCase**: ä» Apifox è·å– OpenAPI æ–‡æ¡£
- **GenerateMockUseCase**: ç”Ÿæˆ Mock æ–‡ä»¶
- **GenerateTypesUseCase**: ç”Ÿæˆ TypeScript ç±»å‹æ–‡ä»¶
- **ServeMockUseCase**: å¯åŠ¨ Mock æœåŠ¡å™¨

### 3. Infrastructure Layerï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰

**èŒè´£**ï¼šå®ç°æ¥å£ï¼Œå¤„ç†å¤–éƒ¨ä¾èµ–ã€‚

- **ApifoxClientImpl**: å®ç° Apifox API è°ƒç”¨
- **FileSystemImpl**: å®ç°æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
- **AxiosHttpClientImpl**: å®ç° HTTP è¯·æ±‚
- **ConsoleLoggerImpl**: å®ç°æ§åˆ¶å°æ—¥å¿—
- **RouteManagerImpl**: å®ç°è·¯ç”±ç®¡ç†
- **RouteLoader**: åŠ¨æ€åŠ è½½ Mock æ–‡ä»¶
- **RemoteProxy**: ä»£ç†è¯·æ±‚åˆ°è¿œç¨‹æœåŠ¡å™¨
- **HotReload**: ç›‘å¬æ–‡ä»¶å˜åŒ–å¹¶çƒ­é‡è½½

### 4. Presentation Layerï¼ˆè¡¨ç°å±‚ï¼‰

**èŒè´£**ï¼šç”¨æˆ·äº¤äº’å…¥å£ã€‚

- **CLI Scripts**: å‘½ä»¤è¡Œè„šæœ¬å…¥å£
- **Express Server**: HTTP æœåŠ¡å™¨è®¾ç½®
- **RouteHandler**: æ ¹æ®å·¥ä½œæ¨¡å¼å¤„ç†è¯·æ±‚ï¼ˆMock/Proxyï¼‰

### 5. Coreï¼ˆæ ¸å¿ƒå±‚ï¼‰

**èŒè´£**ï¼šæä¾›åŸºç¡€è®¾æ–½æ”¯æŒã€‚

- **Container**: ä¾èµ–æ³¨å…¥å®¹å™¨
- **ContainerSetup**: å®¹å™¨åˆå§‹åŒ–ï¼Œæ³¨å†Œæ‰€æœ‰æœåŠ¡
- **ConfigLoader**: åŠ è½½ Apifox é…ç½®
- **MockConfigLoader**: åŠ è½½ Mock æœåŠ¡å™¨é…ç½®

---

## ğŸ”„ æ¨¡å—è”åŠ¨

### 1. ç”Ÿæˆæµç¨‹ï¼ˆGenerateï¼‰

![ç”Ÿæˆæµç¨‹](img/generate-mock.png)

**å…³é”®æ–‡ä»¶**ï¼š
- ```1:57:src/scripts/generate-mock.ts``` - ç”Ÿæˆå‘½ä»¤å…¥å£
- ```13:56:src/application/use-cases/generate-mock.use-case.ts``` - Mock ç”Ÿæˆç”¨ä¾‹

### 2. æœåŠ¡æµç¨‹ï¼ˆServeï¼‰

![ç”Ÿæˆæµç¨‹](img/serve-mock.png)


**å…³é”®æ–‡ä»¶**ï¼š
- ```12:117:src/application/use-cases/serve-mock.use-case.ts``` - æœåŠ¡ç”¨ä¾‹
- ```14:77:src/presentation/http/route-handler.ts``` - è·¯ç”±å¤„ç†å™¨
- ```29:327:src/infrastructure/server/route-loader.ts``` - è·¯ç”±åŠ è½½å™¨

### 3. ä¾èµ–æ³¨å…¥æµç¨‹

![ä¾èµ–æ³¨å…¥æµç¨‹](img/dep-inject.png)


**å…³é”®æ–‡ä»¶**ï¼š
- ```11:83:src/core/container.ts``` - ä¾èµ–æ³¨å…¥å®¹å™¨
- ```23:130:src/core/container-setup.ts``` - å®¹å™¨åˆå§‹åŒ–

---

## ğŸ¯ ä¸»è¦åŠŸèƒ½

### 1. ä» Apifox ç”Ÿæˆ Mock æ–‡ä»¶

**åŠŸèƒ½æè¿°**ï¼šä» Apifox é¡¹ç›®æ‹‰å– OpenAPI æ–‡æ¡£ï¼Œç”Ÿæˆ Mock æ–‡ä»¶å’Œ TypeScript ç±»å‹æ–‡ä»¶ã€‚

**å·¥ä½œæµç¨‹**ï¼š
1. è¯»å– `apifox.config.js` é…ç½®
2. è°ƒç”¨ Apifox API è·å– OpenAPI æ–‡æ¡£
3. å°† OpenAPI è½¬æ¢ä¸º `ApiEndpoint` å®ä½“
4. åº”ç”¨è¿‡æ»¤è§„åˆ™ï¼ˆincludePaths/excludePathsï¼‰
5. æŒ‰è·¯å¾„åˆ†ç»„ï¼Œç”Ÿæˆ Mock æ–‡ä»¶ï¼ˆæ”¯æŒå¢é‡æ›´æ–°ï¼‰
6. ç”Ÿæˆ TypeScript ç±»å‹æ–‡ä»¶

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… æ”¯æŒè·¯å¾„è¿‡æ»¤ï¼ˆincludePaths/excludePathsï¼‰
- âœ… æ”¯æŒå¢é‡æ›´æ–°ï¼ˆä¿ç•™æ‰‹åŠ¨ä¿®æ”¹çš„ä»£ç ï¼‰
- âœ… è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶æ¶æ„å’Œå¯¼å…¥è¯­å¥
- âœ… æ”¯æŒåŠ¨æ€ Mock å‡½æ•°å’Œé™æ€æ•°æ®

### 2. å¯åŠ¨ Mock æœåŠ¡å™¨

**åŠŸèƒ½æè¿°**ï¼šå¯åŠ¨æœ¬åœ° Mock æœåŠ¡å™¨ï¼Œæ”¯æŒ Mock æ¨¡å¼å’Œä»£ç†æ¨¡å¼ã€‚

**å·¥ä½œæ¨¡å¼**ï¼š

#### Mock æ¨¡å¼ï¼ˆ`model: 'mock'`ï¼‰
- é»˜è®¤ä½¿ç”¨æœ¬åœ° Mock æ•°æ®
- å¯é€šè¿‡ `proxyRoutes` é…ç½®ç‰¹å®šè·¯ç”±èµ°ä»£ç†
- æ”¯æŒåŠ¨æ€ Mock å‡½æ•°

#### Proxy æ¨¡å¼ï¼ˆ`model: 'proxy'`ï¼‰
- é»˜è®¤è½¬å‘åˆ°è¿œç¨‹æœåŠ¡å™¨
- å¯é€šè¿‡ `mockRoutes` é…ç½®ç‰¹å®šè·¯ç”±èµ° Mock
- æ”¯æŒåŠ¨æ€åˆ‡æ¢ç›®æ ‡æœåŠ¡å™¨ï¼ˆé€šè¿‡ URL å‚æ•° `?remote`ï¼‰

**è·¯ç”±åŒ¹é…ä¼˜å…ˆçº§**ï¼š
1. URL å‚æ•° `?remote`ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. `mockRoutes` / `proxyRoutes` é…ç½®
3. `model` å…¨å±€é…ç½®ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… æ”¯æŒè·¯å¾„å‚æ•°åŒ¹é…ï¼ˆå¦‚ `/user/:id`ï¼‰
- âœ… æ”¯æŒå‚æ•°éªŒè¯
- âœ… æ”¯æŒçƒ­é‡è½½ï¼ˆä¿®æ”¹ Mock æ–‡ä»¶è‡ªåŠ¨ç”Ÿæ•ˆï¼‰
- âœ… æ”¯æŒè·¯å¾„å‰ç¼€å¤„ç†ï¼ˆ`pathPrefixes`ï¼‰
- âœ… æ”¯æŒè¿œç¨‹ç›®æ ‡åŠ¨æ€åˆ‡æ¢

### 3. è·¯ç”±ç®¡ç†

**åŠŸèƒ½æè¿°**ï¼šåŠ¨æ€åŠ è½½å’Œç®¡ç† Mock è·¯ç”±ã€‚

**å·¥ä½œæµç¨‹**ï¼š
1. æ‰«æ Mock ç›®å½•ä¸‹çš„æ‰€æœ‰ `.js` æ–‡ä»¶
2. è§£ææ–‡ä»¶å†…å®¹ï¼Œæå–è·¯ç”±ä¿¡æ¯ï¼ˆè·¯å¾„ã€æ–¹æ³•ã€å¤„ç†å‡½æ•°ï¼‰
3. åŠ¨æ€å¯¼å…¥æ¨¡å—ï¼Œè·å–å¤„ç†å‡½æ•°
4. æ³¨å†Œåˆ° `RouteManager`
5. æ–‡ä»¶å˜åŒ–æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½ï¼ˆçƒ­é‡è½½ï¼‰

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… æ”¯æŒåŠ¨æ€è·¯ç”±åŠ è½½
- âœ… æ”¯æŒçƒ­é‡è½½
- âœ… æ”¯æŒå¤šç§å‡½æ•°å‘½åæ–¹å¼ï¼ˆç²¾ç¡®åŒ¹é…ã€å‰ç¼€åŒ¹é…ã€defaultï¼‰

### 4. ä»£ç ç”Ÿæˆ

**åŠŸèƒ½æè¿°**ï¼šæ ¹æ® OpenAPI Schema ç”Ÿæˆ Mock æ•°æ®å’Œ TypeScript ç±»å‹ã€‚

**Mock ç”Ÿæˆ**ï¼š
- æ ¹æ® Schema ç”Ÿæˆç¬¦åˆè§„èŒƒçš„ Mock æ•°æ®
- æ”¯æŒåµŒå¥—å¯¹è±¡ã€æ•°ç»„ã€æšä¸¾ç­‰ç±»å‹
- æ”¯æŒè‡ªå®šä¹‰ Mock å‡½æ•°æ¨¡æ¿

**ç±»å‹ç”Ÿæˆ**ï¼š
- ç”Ÿæˆ TypeScript æ¥å£å’Œç±»å‹
- æ”¯æŒè¯·æ±‚/å“åº”ç±»å‹
- æ”¯æŒ Schema å¼•ç”¨è§£æ

---
